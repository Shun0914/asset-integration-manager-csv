# エラーレポート

## 基本情報

- **日時**: 2025-05-04 16:00:00
- **コンポーネント**: FastAPI Backend - Portfolio Models
- **エラータイプ**: ValidationError
- **重要度**: High
- **レポートID**: ERROR_20250504010

## エラー詳細

### エラーメッセージ

```
Value error, 証券コードは4〜5桁の数字である必要があります [type=value_error, input_value='XYZ', input_type=str]
    For further information visit https://errors.pydantic.dev/2.4/v/value_error
items.14.market
  Input should be '東証プライム', '東証スタンダード', '東証グロース', 'JASDAQ', 'マザーズ' or 'その他' [type=enum, input_value='NYSE', input_type=str]
```

### 発生状況

松井証券の米国株式CSVをアップロードした際に、Pydanticモデルのバリデーションエラーが発生しました。特に以下の2点が問題となっています：

1. 米国株式のティッカーシンボル（例：XYZ）が、日本株の証券コード用バリデーション（4〜5桁の数字）にマッチしないため拒否されている
2. 米国市場（例：NYSE）が、MarketEnumに定義されていないため拒否されている

## 原因分析

現在のモデル定義が日本株式のみを想定して作られているため、米国株式のデータが適切にバリデーションされません。具体的には：

1. `StockItem`クラスの`validate_code`メソッドが、証券コードを4〜5桁の数字と限定的にバリデーションしており、アルファベットで構成される米国株のティッカーシンボルを拒否
2. `MarketEnum`が日本の市場区分のみを定義しており、NYSE等の米国市場区分が含まれていない

CSVパーサーサービスでは松井証券の米国株式CSVフォーマットをマッピングできるようになっていますが、モデル定義側での対応が不足しています。

## 解決策

以下の修正を行います：

1. `MarketEnum`に米国市場区分（NYSE, NASDAQ等）を追加
2. `StockItem`クラスの`validate_code`メソッドを修正し、米国株式のティッカーシンボルを許容

具体的な実装として：

- `MarketEnum`クラスに、米国市場の列挙型を追加
- `StockItem`の`validate_code`メソッドを修正し、以下のいずれかの条件に合致すればOKとする：
  - 4〜5桁の数字（従来の日本株式コード）
  - 1〜5文字の英数字（米国株式のティッカーシンボル）

## 予想される影響

この修正により、松井証券の米国株式CSVデータを正常に処理できるようになります。日本株と米国株の両方を同時に取り扱うことが可能になり、ユーザーは複合的なポートフォリオを分析できるようになります。

また、CSVパーサーサービスへの変更は不要であり、モデル定義の修正のみで対応可能です。
