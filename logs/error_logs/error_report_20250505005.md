# エラーレポート

## 基本情報

- **日時**: 2025-05-05 22:30:00
- **コンポーネント**: Backend - API Routing
- **エラータイプ**: RoutingError - Duplicate Prefix
- **重要度**: Critical
- **レポートID**: ERROR_20250505005

## エラー詳細

### エラーメッセージ

```
INFO:     127.0.0.1:55439 - "POST /api/csv/upload HTTP/1.1" 404 Not Found
```

### 発生状況

フロントエンドからCSVファイル（sample_portfolio.csv）をアップロードしようとした際に、バックエンドAPIへのリクエストが404 Not Foundエラーで失敗しました。クライアントは正しく`/api/csv/upload`にPOSTリクエストを送信していますが、サーバー側でこのエンドポイントが見つからない状態でした。

## 原因分析

調査の結果、ルーターのプレフィックス設定に重複があることがわかりました。具体的な問題点は以下の通りです：

1. **プレフィックスの重複**：
   - `main.py`で`api_router`をマウントする際に`prefix="/api"`を指定している
   - さらに`csv.py`のルーター定義でも`prefix="/api/csv"`と指定している
   - 結果として実際のエンドポイントは`/api/api/csv/upload`となっていた

2. **エンドポイント不一致**：
   - フロントエンドは`/api/csv/upload`にリクエストを送信
   - バックエンドは`/api/api/csv/upload`でリクエストを待機
   - この不一致により404エラーが発生

この問題は、前回の修正（ERROR_20250505003, ERROR_20250505004）でmain.pyファイルにAPIプレフィックスを追加したことで発生しました。既存のCSVルーターがすでに`/api`プレフィックスを含んでいたため、重複が生じました。

## 解決策

CSVルーターのプレフィックス設定を修正しました：

1. **CSVルーターのプレフィックス修正**:
   ```python
   # 修正前
   router = APIRouter(
       prefix="/api/csv",
       tags=["csv"],
       responses={...}
   )
   
   # 修正後
   router = APIRouter(
       prefix="/csv",
       tags=["csv"],
       responses={...}
   )
   ```

これにより、main.pyのプレフィックス設定（`/api`）とCSVルーターのプレフィックス設定（`/csv`）が組み合わさって、最終的なエンドポイントが`/api/csv/upload`となり、フロントエンドからのリクエストと一致するようになりました。

## 結果

修正後、フロントエンドからCSVファイルのアップロードが正常に機能するようになりました。404 Not Foundエラーは解消され、サーバーはCSVファイルを正しく受け取り、解析できるようになりました。

## 追加情報

### 教訓

API設計時の重要な教訓：

1. **プレフィックスの階層構造を一貫させる**:
   - 親ルーターと子ルーターでプレフィックスが重複しないようにする
   - 全体的なAPI構造を設計する際は、各レベルでの役割分担を明確にする

2. **APIルーティングの変更時のチェックポイント**:
   - 変更がフロントエンドのリクエストURLと一致していることを確認する
   - 既存のルーターとの整合性をチェックする
   - エンドポイントの階層構造全体を把握する

### 今後の対策

1. **APIエンドポイントのドキュメント整備**:
   - すべてのエンドポイントとその完全なパスを一覧化する
   - フロントエンドとバックエンドでの参照を統一する

2. **自動テストの導入**:
   - API変更後に全エンドポイントの到達性をテストする自動化スクリプトの導入
   - フロントエンド-バックエンド間の通信テストの強化

3. **設計ガイドラインの更新**:
   - API設計時のプレフィックス階層化ルールを明確に文書化する
   - コードレビュープロセスでのチェックポイントとして追加する